<!DOCTYPE html>
<html>
<head>
<title>mapgen.js toolkit</title>
<meta charset="UTF-8" />
<script src="../src/mapgen.js" defer></script>
<script src="../lib/bin-packing/js/packer.js"></script>
<script defer>
window.onload = function(){
	var
		render = document.createElement('canvas'),
		form = document.querySelector('form'),
		gen,
		ctx
	;
	function logError(e){
		var
			errorLog = form.querySelector('#errorLog'),
			li = document.createElement('li')
		;
		li.appendChild(document.createTextNode(e));
		errorLog.insertBefore(li, errorLog.firstChild);
	}
	function doDraw(map, force){
		var
			draw = map.draw(force);
		;
		ctx.save();
		ctx.fillStyle = '#eee';
		ctx.fillRect(0, 0, render.width, render.height);
		ctx.translate(400 + (draw.width / -2), 400 + (draw.height / -2));
		ctx.drawImage(draw, 0, 0);
		ctx.restore();
	}

	function prefUpdate(pref){
		var
			checkOpts = [
				'renderWidth',
				'renderHeight',
				'roadWidth',
				'lineWidth',
				'radius',
				'polyWidth',
				'polyWidthMul',
				'polyHeight',
				'polyHeightMul',
				'failLimit'
			],
			opts = {}
		;
		var
			checkColor = [
				'fill',
				'line'
			]
		;
		checkOpts.forEach(function(e){
			var
				el = form.querySelector('#' + e)
			;
			if(el){
				opts[e] = el.value;
			}
		});
		checkColor.forEach(function(e){
			var
				color = form.querySelector('#' + e + 'Color'),
				opacity = form.querySelector('#' + e + 'Opacity')
			;
			if(color && opacity){
				var
					rgb = color.value.substr(1)
				;
				opts[e + 'R'] = parseInt(color.value.substr(1,2), 16);
				opts[e + 'G'] = parseInt(color.value.substr(3,2), 16);
				opts[e + 'B'] = parseInt(color.value.substr(5,2), 16);
				opts[e + 'A'] = opacity.value;
			}
		});
		if(gen){
			gen['options'](opts);
			if(pref != 'failLimit'){
				try{
					doDraw(gen);
				}catch(e){
					logError(e);
					logError('forcing redraw');
					gen = new mapgen(opts);
					doDraw(gen);
					throw e;
				}
			}
		}else{
			gen = new mapgen(opts);
		}
	}
	prefUpdate();
	render.width = render.height = 800;
	ctx = render.getContext('2d');
	document.body.appendChild(render);
	doDraw(gen);
	form.onsubmit = function(e){
		e.preventDefault();
		doDraw(gen, true);
		return false;
	}
	form.onreset = function(){
		var
			req = (window.requestAnimationFrame != undefined) ? requestAnimationFrame : function(cb){
				setTimeout(cb, 16);
			}
		;
		req(function(){
			var
				outputs = form.querySelectorAll('output')
			;
			for(var i=0;i<outputs.length;++i){
				updateOutput(outputs[i].getAttribute('for'));
			}
			prefUpdate();
			doDraw(gen, true);
		});
	}

	function updateOutput(id){
		var
			output = form.querySelector('output[for="' + id + '"]')

		while(output.hasChildNodes()){
			output.removeChild(output.firstChild);
		}
		output.appendChild(document.createTextNode(form.querySelector('#' + id).value));
	}

	form.oninput = form.onchange = function(e){
		switch(e.target.nodeName){
			case 'INPUT':
				updateOutput(e.target.id);
				prefUpdate(e.target.id);
			break;
		}
	}

	var
		trigger = [77, 79, 82, 83, 69],
		enable = 0,
		taty = function(e){
			if(e.keyCode == trigger[enable]){
				++enable;
				if(enable >= trigger.length){
					var
						mapSelect = document.querySelector('.map-selection .kantvarld')
					;
					if(mapSelect){
						mapSelect.style.display = 'list-item';
						window.removeEventListener('keyup', taty, true);
					}
				}
			}else{
				enable=0;
			}
		}
	;
	window.addEventListener('keyup', function(e){
		if(e.keyCode == trigger[enable]){
			++enable;
			if(enable >= trigger.length){
				['polyWidth', 'polyHeight', 'lineWidth'].forEach(function(e){
					form.querySelector('#' + e).value = 4;

				});
				form.querySelector('#radius').value = 8;
				form.querySelector('#polyWidthMul').value = 2;
				form.querySelector('#polyHeightMul').value = 1;
				['polyWidth', 'polyHeight', 'lineWidth', 'polyWidthMul', 'polyHeightMul', 'radius'].forEach(function(e){
					updateOutput(e);
				});
				prefUpdate();
				doDraw(gen, true);
			}
		}else{
			enable=0;
		}
	}, true);
}
</script>
<style>
canvas{
	background: #fff ;
}
form{
	float: left ;
}
</style>
</head>
<body>
<form>
	<p><a href="https://github.com/SignpostMarv/mapgen.js">GitHub repo</a></p>
	<fieldset>
		<legend>Toolkit</legend>
		<ul>
			<li><label for=renderWidth>Render Width: </label><input id=renderWidth type=range min=100 max=800 value=800><output for=renderWidth>800</output></li>
			<li><label for=renderHeight>Render Height: </label><input id=renderHeight type=range min=100 max=800 value=800><output for=renderHeight>800</output></li>
			<li><label for=roadWidth>Road Width: </label><input id=roadWidth type=range min=4 max=64 value=16><output for=roadWidth>16</output></li>
			<li><label for=failLimit>Fail Limit: </label><input id=failLimit type=range min=1 max=1000 value=4><output for=failLimit>4</output></li>
		</ul>
		<fieldset>
			<legend>Line</legend>
			<ul>
				<li><label for=lineWidth>Line Width: </label><input id=lineWidth type=range min=4 max=64 value=4><output for=lineWidth>4</output></li>
				<li><label for=lineColor>line Color: </label><input id=lineColor type=color value="#000000"><output for=lineColor>#000000</output></li>
				<li><label for=lineOpacity>line Opacity: </label><input id=lineOpacity type=range min=0 max=1 step=0.01 value=1><output for=lineOpacity>1</output></li>
				<li><label for=radius>Radius: </label><input id=radius type=range min=4 max=64 value=16><output for=radius>16</output></li>
			</ul>
		</fieldset>
		<fieldset>
			<legend>Buidling</legend>
			<ul>
				<li><label for=polyWidth>Building Width: </label><input id=polyWidth type=range min=4 max=128 step=4 value=64><output for=polyWidth>64</output></li>
				<li><label for=polyWidthMul>Building Width randomiser: </label><input id=polyWidthMul type=range min=1 max=10 value=3><output for=polyWidthMul>3</output></li>
				<li><label for=polyHeight>Building Height: </label><input id=polyHeight type=range min=4 max=128 step=4 value=64><output for=polyHeight>64</output></li>
				<li><label for=polyHeightMul>Building Height randomiser: </label><input id=polyHeightMul type=range min=1 max=10 value=2><output for=polyHeightMul>2</output></li>
				<li><label for=fillColor>Fill Color: </label><input id=fillColor type=color value="#ffffff"><output for=fillColor>#ffffff</output></li>
				<li><label for=fillOpacity>Fill Opacity: </label><input id=fillOpacity type=range min=0 max=1 step=0.01 value=1><output for=fillOpacity>1</output></li>
			</ul>
		</fieldset>
	</fieldset>
	<button type=submit>Redraw</button>
	<button type=reset>Reset</button>
	<section>
		<h1>Error Log</h1>
		<ol id=errorLog></ol>
	</section>
</form>
</body>
</html>
